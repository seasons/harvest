0651a32880e4a2f179aa8b381626b9a1
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _agent = _interopRequireDefault(require("./agent"));

var _reactNative = require("react-native");

var _url = _interopRequireDefault(require("url"));

var _authError = _interopRequireDefault(require("../auth/authError"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var A0Auth0 = _reactNative.NativeModules.A0Auth0;

var callbackUri = function callbackUri(domain) {
  var bundleIdentifier = A0Auth0.bundleIdentifier;
  return bundleIdentifier.toLowerCase() + "://" + domain + "/" + _reactNative.Platform.OS + "/" + bundleIdentifier + "/callback";
};

var WebAuth = function () {
  function WebAuth(auth) {
    (0, _classCallCheck2.default)(this, WebAuth);
    this.client = auth;
    var baseUrl = auth.baseUrl,
        clientId = auth.clientId,
        domain = auth.domain;
    this.domain = domain;
    this.clientId = clientId;
    this.agent = new _agent.default();
  }

  (0, _createClass2.default)(WebAuth, [{
    key: "authorize",
    value: function authorize() {
      var _this = this;

      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
      var clientId = this.clientId,
          domain = this.domain,
          client = this.client,
          agent = this.agent;
      return agent.newTransaction().then(function (_ref) {
        var state = _ref.state,
            verifier = _ref.verifier,
            defaults = (0, _objectWithoutProperties2.default)(_ref, ["state", "verifier"]);
        var redirectUri = callbackUri(domain);
        var expectedState = options.state || state;

        var query = _objectSpread({}, defaults, {
          clientId: clientId,
          responseType: 'code',
          redirectUri: redirectUri,
          state: expectedState
        }, options);

        var authorizeUrl = _this.client.authorizeUrl(query);

        return agent.show(authorizeUrl).then(function (redirectUrl) {
          if (!redirectUrl || !redirectUrl.startsWith(redirectUri)) {
            throw new _authError.default({
              json: {
                error: 'a0.redirect_uri.not_expected',
                error_description: "Expected " + redirectUri + " but got " + redirectUrl
              },
              status: 0
            });
          }

          var query = _url.default.parse(redirectUrl, true).query;

          var code = query.code,
              resultState = query.state,
              error = query.error;

          if (error) {
            throw new _authError.default({
              json: query,
              status: 0
            });
          }

          if (resultState !== expectedState) {
            throw new _authError.default({
              json: {
                error: 'a0.state.invalid',
                error_description: "Invalid state recieved in redirect url"
              },
              status: 0
            });
          }

          return client.exchange({
            code: code,
            verifier: verifier,
            redirectUri: redirectUri
          });
        });
      });
    }
  }, {
    key: "clearSession",
    value: function clearSession() {
      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
      var client = this.client,
          agent = this.agent,
          domain = this.domain,
          clientId = this.clientId;
      options.clientId = clientId;
      options.returnTo = callbackUri(domain);
      options.federated = options.federated || false;
      var logoutUrl = client.logoutUrl(options);
      return agent.show(logoutUrl, true);
    }
  }]);
  return WebAuth;
}();

exports.default = WebAuth;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIkEwQXV0aDAiLCJOYXRpdmVNb2R1bGVzIiwiY2FsbGJhY2tVcmkiLCJkb21haW4iLCJidW5kbGVJZGVudGlmaWVyIiwidG9Mb3dlckNhc2UiLCJQbGF0Zm9ybSIsIk9TIiwiV2ViQXV0aCIsImF1dGgiLCJjbGllbnQiLCJiYXNlVXJsIiwiY2xpZW50SWQiLCJhZ2VudCIsIkFnZW50Iiwib3B0aW9ucyIsIm5ld1RyYW5zYWN0aW9uIiwidGhlbiIsInN0YXRlIiwidmVyaWZpZXIiLCJkZWZhdWx0cyIsInJlZGlyZWN0VXJpIiwiZXhwZWN0ZWRTdGF0ZSIsInF1ZXJ5IiwicmVzcG9uc2VUeXBlIiwiYXV0aG9yaXplVXJsIiwic2hvdyIsInJlZGlyZWN0VXJsIiwic3RhcnRzV2l0aCIsIkF1dGhFcnJvciIsImpzb24iLCJlcnJvciIsImVycm9yX2Rlc2NyaXB0aW9uIiwic3RhdHVzIiwidXJsIiwicGFyc2UiLCJjb2RlIiwicmVzdWx0U3RhdGUiLCJleGNoYW5nZSIsInJldHVyblRvIiwiZmVkZXJhdGVkIiwibG9nb3V0VXJsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7Ozs7O0lBRVFBLE8sR0FBWUMsMEIsQ0FBWkQsTzs7QUFFUixJQUFNRSxXQUFXLEdBQUcsU0FBZEEsV0FBYyxDQUFBQyxNQUFNLEVBQUk7QUFDNUIsTUFBTUMsZ0JBQWdCLEdBQUdKLE9BQU8sQ0FBQ0ksZ0JBQWpDO0FBQ0EsU0FBVUEsZ0JBQWdCLENBQUNDLFdBQWpCLEVBQVYsV0FBOENGLE1BQTlDLFNBQ0VHLHNCQUFTQyxFQURYLFNBRUlILGdCQUZKO0FBR0QsQ0FMRDs7SUFpQnFCSSxPO0FBQ25CLG1CQUFZQyxJQUFaLEVBQWtCO0FBQUE7QUFDaEIsU0FBS0MsTUFBTCxHQUFjRCxJQUFkO0FBRGdCLFFBRVJFLE9BRlEsR0FFc0JGLElBRnRCLENBRVJFLE9BRlE7QUFBQSxRQUVDQyxRQUZELEdBRXNC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RCxPQXRDTSxDQUFQO0FBdUNEOzs7bUNBYzBCO0FBQUEsVUFBZE4sT0FBYyx1RUFBSixFQUFJO0FBQUEsVUFDakJMLE1BRGlCLEdBQ21CLElBRG5CLENBQ2pCQSxNQURpQjtBQUFBLFVBQ1RHLEtBRFMsR0FDbUIsSUFEbkIsQ0FDVEEsS0FEUztBQUFBLFVBQ0ZWLE1BREUsR0FDbUIsSUFEbkIsQ0FDRkEsTUFERTtBQUFBLFVBQ01TLFFBRE4sR0FDbUIsSUFEbkIsQ0FDTUEsUUFETjtBQUV6QkcsTUFBQUEsT0FBTyxDQUFDSCxRQUFSLEdBQW1CQSxRQUFuQjtBQUNBRyxNQUFBQSxPQUFPLENBQUN3QixRQUFSLEdBQW1CckMsV0FBVyxDQUFDQyxNQUFELENBQTlCO0FBQ0FZLE1BQUFBLE9BQU8sQ0FBQ3lCLFNBQVIsR0FBb0J6QixPQUFPLENBQUN5QixTQUFSLElBQXFCLEtBQXpDO0FBQ0EsVUFBTUMsU0FBUyxHQUFHL0IsTUFBTSxDQUFDK0IsU0FBUCxDQUFpQjFCLE9BQWpCLENBQWxCO0FBQ0EsYUFBT0YsS0FBSyxDQUFDYSxJQUFOLENBQVdlLFNBQVgsRUFBc0IsSUFBdEIsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEFnZW50IGZyb20gJy4vYWdlbnQnO1xuaW1wb3J0IHsgTmF0aXZlTW9kdWxlcywgUGxhdGZvcm0gfSBmcm9tICdyZWFjdC1uYXRpdmUnO1xuXG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgQXV0aEVycm9yIGZyb20gJy4uL2F1dGgvYXV0aEVycm9yJztcblxuY29uc3QgeyBBMEF1dGgwIH0gPSBOYXRpdmVNb2R1bGVzO1xuXG5jb25zdCBjYWxsYmFja1VyaSA9IGRvbWFpbiA9PiB7XG4gIGNvbnN0IGJ1bmRsZUlkZW50aWZpZXIgPSBBMEF1dGgwLmJ1bmRsZUlkZW50aWZpZXI7XG4gIHJldHVybiBgJHtidW5kbGVJZGVudGlmaWVyLnRvTG93ZXJDYXNlKCl9Oi8vJHtkb21haW59LyR7XG4gICAgUGxhdGZvcm0uT1NcbiAgfS8ke2J1bmRsZUlkZW50aWZpZXJ9L2NhbGxiYWNrYDtcbn07XG5cbi8qKlxuICogSGVscGVyIHRvIHBlcmZvcm0gQXV0aCBhZ2FpbnN0IEF1dGgwIGhvc3RlZCBsb2dpbiBwYWdlXG4gKlxuICogSXQgd2lsbCB1c2UgYC9hdXRob3JpemVgIGVuZHBvaW50IG9mIHRoZSBBdXRob3JpemF0aW9uIFNlcnZlciAoQVMpXG4gKiB3aXRoIENvZGUgR3JhbnQgYW5kIFByb29mIEtleSBmb3IgQ2hhbGxlbmdlIEV4Y2hhbmdlIChQS0NFKS5cbiAqXG4gKiBAZXhwb3J0XG4gKiBAY2xhc3MgV2ViQXV0aFxuICogQHNlZSBodHRwczovL2F1dGgwLmNvbS9kb2NzL2FwaS1hdXRoL2dyYW50L2F1dGhvcml6YXRpb24tY29kZS1wa2NlXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdlYkF1dGgge1xuICBjb25zdHJ1Y3RvcihhdXRoKSB7XG4gICAgdGhpcy5jbGllbnQgPSBhdXRoO1xuICAgIGNvbnN0IHsgYmFzZVVybCwgY2xpZW50SWQsIGRvbWFpbiB9ID0gYXV0aDtcbiAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbjtcbiAgICB0aGlzLmNsaWVudElkID0gY2xpZW50SWQ7XG4gICAgdGhpcy5hZ2VudCA9IG5ldyBBZ2VudCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0cyB0aGUgQXV0aE4vQXV0aFogdHJhbnNhY3Rpb24gYWdhaW5zdCB0aGUgQVMgaW4gdGhlIGluLWFwcCBicm93c2VyLlxuICAgKlxuICAgKiBJbiBpT1MgaXQgd2lsbCB1c2UgYFNGU2FmYXJpVmlld0NvbnRyb2xsZXJgIGFuZCBpbiBBbmRyb2lkIENocm9tZSBDdXN0b20gVGFicy5cbiAgICpcbiAgICogVG8gbGVhcm4gbW9yZSBhYm91dCBob3cgdG8gY3VzdG9taXplIHRoZSBhdXRob3JpemUgY2FsbCwgY2hlY2sgdGhlIFVuaXZlcnNhbCBMb2dpbiBQYWdlXG4gICAqIGFydGljbGUgYXQgaHR0cHM6Ly9hdXRoMC5jb20vZG9jcy9ob3N0ZWQtcGFnZXMvbG9naW5cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtZXRlcnMgcGFyYW1ldGVycyB0byBzZW5kXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBbcGFyYW1ldGVycy5zdGF0ZV0gcmFuZG9tIHN0cmluZyB0byBwcmV2ZW50IENTUkYgYXR0YWNrcyBhbmQgdXNlZCB0byBkaXNjYXJkIHVuZXhlcGN0ZWQgcmVzdWx0cy4gQnkgZGVmYXVsdCBpdHMgYSBjcnlwdG9ncmFwaGljYWxseSBzZWN1cmUgcmFuZG9tLlxuICAgKiBAcGFyYW0ge1N0cmluZ30gW3BhcmFtZXRlcnMubm9uY2VdIHJhbmRvbSBzdHJpbmcgdG8gcHJldmVudCByZXBsYXkgYXR0YWNrcyBvZiBpZF90b2tlbnMuXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBbcGFyYW1ldGVycy5hdWRpZW5jZV0gaWRlbnRpZmllciBvZiBSZXNvdXJjZSBTZXJ2ZXIgKFJTKSB0byBiZSBpbmNsdWRlZCBhcyBhdWRpZW5jZSAoYXVkIGNsYWltKSBvZiB0aGUgaXNzdWVkIGFjY2VzcyB0b2tlblxuICAgKiBAcGFyYW0ge1N0cmluZ30gW3BhcmFtZXRlcnMuc2NvcGVdIHNjb3BlcyByZXF1ZXN0ZWQgZm9yIHRoZSBpc3N1ZWQgdG9rZW5zLiBlLmcuIGBvcGVuaWQgcHJvZmlsZWBcbiAgICogQHBhcmFtIHtTdHJpbmd9IFtwYXJhbWV0ZXJzLmNvbm5lY3Rpb25dIFRoZSBuYW1lIG9mIHRoZSBpZGVudGl0eSBwcm92aWRlciB0byB1c2UsIGUuZy4gXCJnb29nbGUtb2F1dGgyXCIgb3IgXCJmYWNlYm9va1wiLiBXaGVuIG5vdCBzZXQsIGl0IHdpbGwgZGlzcGxheSBBdXRoMCdzIFVuaXZlcnNhbCBMb2dpbiBQYWdlLlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICogQHNlZSBodHRwczovL2F1dGgwLmNvbS9kb2NzL2FwaS9hdXRoZW50aWNhdGlvbiNhdXRob3JpemUtY2xpZW50XG4gICAqXG4gICAqIEBtZW1iZXJvZiBXZWJBdXRoXG4gICAqL1xuICBhdXRob3JpemUob3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgeyBjbGllbnRJZCwgZG9tYWluLCBjbGllbnQsIGFnZW50IH0gPSB0aGlzO1xuICAgIHJldHVybiBhZ2VudC5uZXdUcmFuc2FjdGlvbigpLnRoZW4oKHsgc3RhdGUsIHZlcmlmaWVyLCAuLi5kZWZhdWx0cyB9KSA9PiB7XG4gICAgICBjb25zdCByZWRpcmVjdFVyaSA9IGNhbGxiYWNrVXJpKGRvbWFpbik7XG4gICAgICBjb25zdCBleHBlY3RlZFN0YXRlID0gb3B0aW9ucy5zdGF0ZSB8fCBzdGF0ZTtcbiAgICAgIGxldCBxdWVyeSA9IHtcbiAgICAgICAgLi4uZGVmYXVsdHMsXG4gICAgICAgIGNsaWVudElkLFxuICAgICAgICByZXNwb25zZVR5cGU6ICdjb2RlJyxcbiAgICAgICAgcmVkaXJlY3RVcmksXG4gICAgICAgIHN0YXRlOiBleHBlY3RlZFN0YXRlLFxuICAgICAgICAuLi5vcHRpb25zXG4gICAgICB9O1xuICAgICAgY29uc3QgYXV0aG9yaXplVXJsID0gdGhpcy5jbGllbnQuYXV0aG9yaXplVXJsKHF1ZXJ5KTtcbiAgICAgIHJldHVybiBhZ2VudC5zaG93KGF1dGhvcml6ZVVybCkudGhlbihyZWRpcmVjdFVybCA9PiB7XG4gICAgICAgIGlmICghcmVkaXJlY3RVcmwgfHwgIXJlZGlyZWN0VXJsLnN0YXJ0c1dpdGgocmVkaXJlY3RVcmkpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEF1dGhFcnJvcih7XG4gICAgICAgICAgICBqc29uOiB7XG4gICAgICAgICAgICAgIGVycm9yOiAnYTAucmVkaXJlY3RfdXJpLm5vdF9leHBlY3RlZCcsXG4gICAgICAgICAgICAgIGVycm9yX2Rlc2NyaXB0aW9uOiBgRXhwZWN0ZWQgJHtyZWRpcmVjdFVyaX0gYnV0IGdvdCAke3JlZGlyZWN0VXJsfWBcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdGF0dXM6IDBcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBxdWVyeSA9IHVybC5wYXJzZShyZWRpcmVjdFVybCwgdHJ1ZSkucXVlcnk7XG4gICAgICAgIGNvbnN0IHsgY29kZSwgc3RhdGU6IHJlc3VsdFN0YXRlLCBlcnJvciB9ID0gcXVlcnk7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIHRocm93IG5ldyBBdXRoRXJyb3IoeyBqc29uOiBxdWVyeSwgc3RhdHVzOiAwIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHRTdGF0ZSAhPT0gZXhwZWN0ZWRTdGF0ZSkge1xuICAgICAgICAgIHRocm93IG5ldyBBdXRoRXJyb3Ioe1xuICAgICAgICAgICAganNvbjoge1xuICAgICAgICAgICAgICBlcnJvcjogJ2EwLnN0YXRlLmludmFsaWQnLFxuICAgICAgICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbjogYEludmFsaWQgc3RhdGUgcmVjaWV2ZWQgaW4gcmVkaXJlY3QgdXJsYFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHN0YXR1czogMFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjbGllbnQuZXhjaGFuZ2UoeyBjb2RlLCB2ZXJpZmllciwgcmVkaXJlY3RVcmkgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiAgUmVtb3ZlcyBBdXRoMCBzZXNzaW9uIGFuZCBvcHRpb25hbGx5IHJlbW92ZSB0aGUgSWRlbnRpdHkgUHJvdmlkZXIgc2Vzc2lvbi5cbiAgICpcbiAgICogIEluIGlPUyBpdCB3aWxsIHVzZSBgU0ZTYWZhcmlWaWV3Q29udHJvbGxlcmAgYW5kIGluIEFuZHJvaWQgQ2hyb21lIEN1c3RvbSBUYWJzLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1ldGVycyBwYXJhbWV0ZXJzIHRvIHNlbmRcbiAgICogQHBhcmFtIHtCb29sfSBbcGFyYW1ldGVycy5mZWRlcmF0ZWRdIE9wdGlvbmFsbHkgcmVtb3ZlIHRoZSBJZFAgc2Vzc2lvbi5cbiAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAqIEBzZWUgaHR0cHM6Ly9hdXRoMC5jb20vZG9jcy9sb2dvdXRcbiAgICpcbiAgICogQG1lbWJlcm9mIFdlYkF1dGhcbiAgICovXG4gIGNsZWFyU2Vzc2lvbihvcHRpb25zID0ge30pIHtcbiAgICBjb25zdCB7IGNsaWVudCwgYWdlbnQsIGRvbWFpbiwgY2xpZW50SWQgfSA9IHRoaXM7XG4gICAgb3B0aW9ucy5jbGllbnRJZCA9IGNsaWVudElkO1xuICAgIG9wdGlvbnMucmV0dXJuVG8gPSBjYWxsYmFja1VyaShkb21haW4pO1xuICAgIG9wdGlvbnMuZmVkZXJhdGVkID0gb3B0aW9ucy5mZWRlcmF0ZWQgfHwgZmFsc2U7XG4gICAgY29uc3QgbG9nb3V0VXJsID0gY2xpZW50LmxvZ291dFVybChvcHRpb25zKTtcbiAgICByZXR1cm4gYWdlbnQuc2hvdyhsb2dvdXRVcmwsIHRydWUpO1xuICB9XG59XG4iXX0=