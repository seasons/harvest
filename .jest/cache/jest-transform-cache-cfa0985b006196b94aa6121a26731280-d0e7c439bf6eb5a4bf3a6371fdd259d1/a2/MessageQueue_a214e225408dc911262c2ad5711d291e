42f1eb98a222130f5f66b04c3c8a59b8
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var ErrorUtils = require('ErrorUtils');

var Systrace = require('Systrace');

var deepFreezeAndThrowOnMutationInDev = require('deepFreezeAndThrowOnMutationInDev');

var invariant = require('invariant');

var stringifySafe = require('stringifySafe');

var TO_JS = 0;
var TO_NATIVE = 1;
var MODULE_IDS = 0;
var METHOD_IDS = 1;
var PARAMS = 2;
var MIN_TIME_BETWEEN_FLUSHES_MS = 5;
var TRACE_TAG_REACT_APPS = 1 << 17;
var DEBUG_INFO_LIMIT = 32;

var MessageQueue = function () {
  function MessageQueue() {
    (0, _classCallCheck2.default)(this, MessageQueue);
    this._lazyCallableModules = {};
    this._queue = [[], [], [], 0];
    this._successCallbacks = {};
    this._failureCallbacks = {};
    this._callID = 0;
    this._lastFlush = 0;
    this._eventLoopStartTime = Date.now();
    this._immediatesCallback = null;

    if (__DEV__) {
      this._debugInfo = {};
      this._remoteModuleTable = {};
      this._remoteMethodTable = {};
    }

    this.callFunctionReturnFlushedQueue = this.callFunctionReturnFlushedQueue.bind(this);
    this.callFunctionReturnResultAndFlushedQueue = this.callFunctionReturnResultAndFlushedQueue.bind(this);
    this.flushedQueue = this.flushedQueue.bind(this);
    this.invokeCallbackAndReturnFlushedQueue = this.invokeCallbackAndReturnFlushedQueue.bind(this);
  }

  (0, _createClass2.default)(MessageQueue, [{
    key: "callFunctionReturnFlushedQueue",
    value: function callFunctionReturnFlushedQueue(module, method, args) {
      var _this = this;

      this.__guard(function () {
        _this.__callFunction(module, method, args);
      });

      return this.flushedQueue();
    }
  }, {
    key: "callFunctionReturnResultAndFlushedQueue",
    value: function callFunctionReturnResultAndFlushedQueue(module, method, args) {
      var _this2 = this;

      var result;

      this.__guard(function () {
        result = _this2.__callFunction(module, method, args);
      });

      return [result, this.flushedQueue()];
    }
  }, {
    key: "invokeCallbackAndReturnFlushedQueue",
    value: function invokeCallbackAndReturnFlushedQueue(cbID, args) {
      var _this3 = this;

      this.__guard(function () {
        _this3.__invokeCallback(cbID, args);
      });

      return this.flushedQueue();
    }
  }, {
    key: "flushedQueue",
    value: function flushedQueue() {
      var _this4 = this;

      this.__guard(function () {
        _this4.__callImmediates();
      });

      var queue = this._queue;
      this._queue = [[], [], [], this._callID];
      return queue[0].length ? queue : null;
    }
  }, {
    key: "getEventLoopRunningTime",
    value: function getEventLoopRunningTime() {
      return Date.now() - this._eventLoopStartTime;
    }
  }, {
    key: "registerCallableModule",
    value: function registerCallableModule(name, module) {
      this._lazyCallableModules[name] = function () {
        return module;
      };
    }
  }, {
    key: "registerLazyCallableModule",
    value: function registerLazyCallableModule(name, factory) {
      var module;
      var getValue = factory;

      this._lazyCallableModules[name] = function () {
        if (getValue) {
          module = getValue();
          getValue = null;
        }

        return module;
      };
    }
  }, {
    key: "getCallableModule",
    value: function getCallableModule(name) {
      var getValue = this._lazyCallableModules[name];
      return getValue ? getValue() : null;
    }
  }, {
    key: "enqueueNativeCall",
    value: function enqueueNativeCall(moduleID, methodID, params, onFail, onSucc) {
      if (onFail || onSucc) {
        if (__DEV__) {
          this._debugInfo[this._callID] = [moduleID, methodID];

          if (this._callID > DEBUG_INFO_LIMIT) {
            delete this._debugInfo[this._callID - DEBUG_INFO_LIMIT];
          }
        }

        onFail && params.push(this._callID << 1);
        onSucc && params.push(this._callID << 1 | 1);
        this._successCallbacks[this._callID] = onSucc;
        this._failureCallbacks[this._callID] = onFail;
      }

      if (__DEV__) {
        global.nativeTraceBeginAsyncFlow && global.nativeTraceBeginAsyncFlow(TRACE_TAG_REACT_APPS, 'native', this._callID);
      }

      this._callID++;

      this._queue[MODULE_IDS].push(moduleID);

      this._queue[METHOD_IDS].push(methodID);

      if (__DEV__) {
        var isValidArgument = function isValidArgument(val) {
          var t = typeof val;

          if (t === 'undefined' || t === 'null' || t === 'boolean' || t === 'string') {
            return true;
          }

          if (t === 'number') {
            return isFinite(val);
          }

          if (t === 'function' || t !== 'object') {
            return false;
          }

          if (Array.isArray(val)) {
            return val.every(isValidArgument);
          }

          for (var k in val) {
            if (typeof val[k] !== 'function' && !isValidArgument(val[k])) {
              return false;
            }
          }

          return true;
        };

        var replacer = function replacer(key, val) {
          var t = typeof val;

          if (t === 'function') {
            return '<<Function ' + val.name + '>>';
          } else if (t === 'number' && !isFinite(val)) {
            return '<<' + val.toString() + '>>';
          } else {
            return val;
          }
        };

        invariant(isValidArgument(params), '%s is not usable as a native method argument', JSON.stringify(params, replacer));
        deepFreezeAndThrowOnMutationInDev(params);
      }

      this._queue[PARAMS].push(params);

      var now = Date.now();

      if (global.nativeFlushQueueImmediate && now - this._lastFlush >= MIN_TIME_BETWEEN_FLUSHES_MS) {
        var queue = this._queue;
        this._queue = [[], [], [], this._callID];
        this._lastFlush = now;
        global.nativeFlushQueueImmediate(queue);
      }

      Systrace.counterEvent('pending_js_to_native_queue', this._queue[0].length);

      if (__DEV__ && this.__spy && isFinite(moduleID)) {
        this.__spy({
          type: TO_NATIVE,
          module: this._remoteModuleTable[moduleID],
          method: this._remoteMethodTable[moduleID][methodID],
          args: params
        });
      } else if (this.__spy) {
        this.__spy({
          type: TO_NATIVE,
          module: moduleID + '',
          method: methodID,
          args: params
        });
      }
    }
  }, {
    key: "createDebugLookup",
    value: function createDebugLookup(moduleID, name, methods) {
      if (__DEV__) {
        this._remoteModuleTable[moduleID] = name;
        this._remoteMethodTable[moduleID] = methods;
      }
    }
  }, {
    key: "setImmediatesCallback",
    value: function setImmediatesCallback(fn) {
      this._immediatesCallback = fn;
    }
  }, {
    key: "__guard",
    value: function __guard(fn) {
      if (this.__shouldPauseOnThrow()) {
        fn();
      } else {
        try {
          fn();
        } catch (error) {
          ErrorUtils.reportFatalError(error);
        }
      }
    }
  }, {
    key: "__shouldPauseOnThrow",
    value: function __shouldPauseOnThrow() {
      return typeof DebuggerInternal !== 'undefined' && DebuggerInternal.shouldPauseOnThrow === true;
    }
  }, {
    key: "__callImmediates",
    value: function __callImmediates() {
      Systrace.beginEvent('JSTimers.callImmediates()');

      if (this._immediatesCallback != null) {
        this._immediatesCallback();
      }

      Systrace.endEvent();
    }
  }, {
    key: "__callFunction",
    value: function __callFunction(module, method, args) {
      this._lastFlush = Date.now();
      this._eventLoopStartTime = this._lastFlush;

      if (__DEV__ || this.__spy) {
        Systrace.beginEvent(module + "." + method + "(" + stringifySafe(args) + ")");
      } else {
        Systrace.beginEvent(module + "." + method + "(...)");
      }

      if (this.__spy) {
        this.__spy({
          type: TO_JS,
          module: module,
          method: method,
          args: args
        });
      }

      var moduleMethods = this.getCallableModule(module);
      invariant(!!moduleMethods, 'Module %s is not a registered callable module (calling %s)', module, method);
      invariant(!!moduleMethods[method], 'Method %s does not exist on module %s', method, module);
      var result = moduleMethods[method].apply(moduleMethods, args);
      Systrace.endEvent();
      return result;
    }
  }, {
    key: "__invokeCallback",
    value: function __invokeCallback(cbID, args) {
      this._lastFlush = Date.now();
      this._eventLoopStartTime = this._lastFlush;
      var callID = cbID >>> 1;
      var isSuccess = cbID & 1;
      var callback = isSuccess ? this._successCallbacks[callID] : this._failureCallbacks[callID];

      if (__DEV__) {
        var debug = this._debugInfo[callID];

        var _module = debug && this._remoteModuleTable[debug[0]];

        var method = debug && this._remoteMethodTable[debug[0]][debug[1]];

        if (!callback) {
          var errorMessage = "Callback with id " + cbID + ": " + _module + "." + method + "() not found";

          if (method) {
            errorMessage = "The callback " + method + "() exists in module " + _module + ", " + 'but only one callback may be registered to a function in a native module.';
          }

          invariant(callback, errorMessage);
        }

        var profileName = debug ? '<callback for ' + _module + '.' + method + '>' : cbID;

        if (callback && this.__spy) {
          this.__spy({
            type: TO_JS,
            module: null,
            method: profileName,
            args: args
          });
        }

        Systrace.beginEvent("MessageQueue.invokeCallback(" + profileName + ", " + stringifySafe(args) + ")");
      }

      if (!callback) {
        return;
      }

      delete this._successCallbacks[callID];
      delete this._failureCallbacks[callID];
      callback.apply(void 0, (0, _toConsumableArray2.default)(args));

      if (__DEV__) {
        Systrace.endEvent();
      }
    }
  }], [{
    key: "spy",
    value: function spy(spyOrToggle) {
      if (spyOrToggle === true) {
        MessageQueue.prototype.__spy = function (info) {
          console.log((info.type === TO_JS ? 'N->JS' : 'JS->N') + " : " + ("" + (info.module ? info.module + '.' : '') + info.method) + ("(" + JSON.stringify(info.args) + ")"));
        };
      } else if (spyOrToggle === false) {
        MessageQueue.prototype.__spy = null;
      } else {
        MessageQueue.prototype.__spy = spyOrToggle;
      }
    }
  }]);
  return MessageQueue;
}();

module.exports = MessageQueue;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk1lc3NhZ2VRdWV1ZS5qcyJdLCJuYW1lcyI6WyJFcnJvclV0aWxzIiwicmVxdWlyZSIsIlN5c3RyYWNlIiwiZGVlcEZyZWV6ZUFuZFRocm93T25NdXRhdGlvbkluRGV2IiwiaW52YXJpYW50Iiwic3RyaW5naWZ5U2FmZSIsIlRPX0pTIiwiVE9fTkFUSVZFIiwiTU9EVUxFX0lEUyIsIk1FVEhPRF9JRFMiLCJQQVJBTVMiLCJNSU5fVElNRV9CRVRXRUVOX0ZMVVNIRVNfTVMiLCJUUkFDRV9UQUdfUkVBQ1RfQVBQUyIsIkRFQlVHX0lORk9fTElNSVQiLCJNZXNzYWdlUXVldWUiLCJfbGF6eUNhbGxhYmxlTW9kdWxlcyIsIl9xdWV1ZSIsIl9zdWNjZXNzQ2FsbGJhY2tzIiwiX2ZhaWx1cmVDYWxsYmFja3MiLCJfY2FsbElEIiwiX2xhc3RGbHVzaCIsIl9ldmVudExvb3BTdGFydFRpbWUiLCJEYXRlIiwibm93IiwiX2ltbWVkaWF0ZXNDYWxsYmFjayIsIl9fREVWX18iLCJfZGVidWdJbmZvIiwiX3JlbW90ZU1vZHVsZVRhYmxlIiwiX3JlbW90ZU1ldGhvZFRhYmxlIiwiY2FsbEZ1bmN0aW9uUmV0dXJuRmx1c2hlZFF1ZXVlIiwiYmluZCIsImNhbGxGdW5jdGlvblJldHVyblJlc3VsdEFuZEZsdXNoZWRRdWV1ZSIsImZsdXNoZWRRdWV1ZSIsImludm9rZUNhbGxiYWNrQW5kUmV0dXJuRmx1c2hlZFF1ZXVlIiwibW9kdWxlIiwibWV0aG9kIiwiYXJncyIsIl9fZ3VhcmQiLCJfX2NhbGxGdW5jdGlvbiIsInJlc3VsdCIsImNiSUQiLCJfX2ludm9rZUNhbGxiYWNrIiwiX19jYWxsSW1tZWRpYXRlcyIsInF1ZXVlIiwibGVuZ3RoIiwibmFtZSIsImZhY3RvcnkiLCJnZXRWYWx1ZSIsIm1vZHVsZUlEIiwibWV0aG9kSUQiLCJwYXJhbXMiLCJvbkZhaWwiLCJvblN1Y2MiLCJwdXNoIiwiZ2xvYmFsIiwibmF0aXZlVHJhY2VCZWdpbkFzeW5jRmxvdyIsImlzVmFsaWRBcmd1bWVudCIsInZhbCIsInQiLCJpc0Zpbml0ZSIsIkFycmF5IiwiaXNBcnJheSIsImV2ZXJ5IiwiayIsInJlcGxhY2VyIiwia2V5IiwidG9TdHJpbmciLCJKU09OIiwic3RyaW5naWZ5IiwibmF0aXZlRmx1c2hRdWV1ZUltbWVkaWF0ZSIsImNvdW50ZXJFdmVudCIsIl9fc3B5IiwidHlwZSIsIm1ldGhvZHMiLCJmbiIsIl9fc2hvdWxkUGF1c2VPblRocm93IiwiZXJyb3IiLCJyZXBvcnRGYXRhbEVycm9yIiwiRGVidWdnZXJJbnRlcm5hbCIsInNob3VsZFBhdXNlT25UaHJvdyIsImJlZ2luRXZlbnQiLCJlbmRFdmVudCIsIm1vZHVsZU1ldGhvZHMiLCJnZXRDYWxsYWJsZU1vZHVsZSIsImFwcGx5IiwiY2FsbElEIiwiaXNTdWNjZXNzIiwiY2FsbGJhY2siLCJkZWJ1ZyIsImVycm9yTWVzc2FnZSIsInByb2ZpbGVOYW1lIiwic3B5T3JUb2dnbGUiLCJwcm90b3R5cGUiLCJpbmZvIiwiY29uc29sZSIsImxvZyIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVVBOzs7Ozs7Ozs7O0FBRUEsSUFBTUEsVUFBVSxHQUFHQyxPQUFPLENBQUMsWUFBRCxDQUExQjs7QUFDQSxJQUFNQyxRQUFRLEdBQUdELE9BQU8sQ0FBQyxVQUFELENBQXhCOztBQUVBLElBQU1FLGlDQUFpQyxHQUFHRixPQUFPLENBQUMsbUNBQUQsQ0FBakQ7O0FBQ0EsSUFBTUcsU0FBUyxHQUFHSCxPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFDQSxJQUFNSSxhQUFhLEdBQUdKLE9BQU8sQ0FBQyxlQUFELENBQTdCOztBQVNBLElBQU1LLEtBQUssR0FBRyxDQUFkO0FBQ0EsSUFBTUMsU0FBUyxHQUFHLENBQWxCO0FBRUEsSUFBTUMsVUFBVSxHQUFHLENBQW5CO0FBQ0EsSUFBTUMsVUFBVSxHQUFHLENBQW5CO0FBQ0EsSUFBTUMsTUFBTSxHQUFHLENBQWY7QUFDQSxJQUFNQywyQkFBMkIsR0FBRyxDQUFwQztBQUdBLElBQU1DLG9CQUFvQixHQUFHLEtB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ZCxHQUFzQixPQUF0QixHQUFnQyxPQUFuQyxtQkFDS3VGLElBQUksQ0FBQzNELE1BQUwsR0FBYzJELElBQUksQ0FBQzNELE1BQUwsR0FBYyxHQUE1QixHQUFrQyxFQUR2QyxJQUM0QzJELElBQUksQ0FBQzFELE1BRGpELFdBRU1nQyxJQUFJLENBQUNDLFNBQUwsQ0FBZXlCLElBQUksQ0FBQ3pELElBQXBCLENBRk4sT0FERjtBQUtELFNBTkQ7QUFPRCxPQVJELE1BUU8sSUFBSXVELFdBQVcsS0FBSyxLQUFwQixFQUEyQjtBQUNoQzdFLFFBQUFBLFlBQVksQ0FBQzhFLFNBQWIsQ0FBdUJyQixLQUF2QixHQUErQixJQUEvQjtBQUNELE9BRk0sTUFFQTtBQUNMekQsUUFBQUEsWUFBWSxDQUFDOEUsU0FBYixDQUF1QnJCLEtBQXZCLEdBQStCb0IsV0FBL0I7QUFDRDtBQUNGOzs7OztBQWdVSHpELE1BQU0sQ0FBQzhELE9BQVAsR0FBaUJsRixZQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqIEBmb3JtYXRcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IEVycm9yVXRpbHMgPSByZXF1aXJlKCdFcnJvclV0aWxzJyk7XG5jb25zdCBTeXN0cmFjZSA9IHJlcXVpcmUoJ1N5c3RyYWNlJyk7XG5cbmNvbnN0IGRlZXBGcmVlemVBbmRUaHJvd09uTXV0YXRpb25JbkRldiA9IHJlcXVpcmUoJ2RlZXBGcmVlemVBbmRUaHJvd09uTXV0YXRpb25JbkRldicpO1xuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnaW52YXJpYW50Jyk7XG5jb25zdCBzdHJpbmdpZnlTYWZlID0gcmVxdWlyZSgnc3RyaW5naWZ5U2FmZScpO1xuXG5leHBvcnQgdHlwZSBTcHlEYXRhID0ge1xuICB0eXBlOiBudW1iZXIsXG4gIG1vZHVsZTogP3N0cmluZyxcbiAgbWV0aG9kOiBzdHJpbmcgfCBudW1iZXIsXG4gIGFyZ3M6IGFueVtdLFxufTtcblxuY29uc3QgVE9fSlMgPSAwO1xuY29uc3QgVE9fTkFUSVZFID0gMTtcblxuY29uc3QgTU9EVUxFX0lEUyA9IDA7XG5jb25zdCBNRVRIT0RfSURTID0gMTtcbmNvbnN0IFBBUkFNUyA9IDI7XG5jb25zdCBNSU5fVElNRV9CRVRXRUVOX0ZMVVNIRVNfTVMgPSA1O1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYml0d2lzZVxuY29uc3QgVFJBQ0VfVEFHX1JFQUNUX0FQUFMgPSAxIDw8IDE3O1xuXG5jb25zdCBERUJVR19JTkZPX0xJTUlUID0gMzI7XG5cbmNsYXNzIE1lc3NhZ2VRdWV1ZSB7XG4gIF9sYXp5Q2FsbGFibGVNb2R1bGVzOiB7W2tleTogc3RyaW5nXTogKHZvaWQpID0+IE9iamVjdH07XG4gIF9xdWV1ZTogW251bWJlcltdLCBudW1iZXJbXSwgYW55W10sIG51bWJlcl07XG4gIF9zdWNjZXNzQ2FsbGJhY2tzOiB7W2tleTogbnVtYmVyXTogP0Z1bmN0aW9ufTtcbiAgX2ZhaWx1cmVDYWxsYmFja3M6IHtba2V5OiBudW1iZXJdOiA/RnVuY3Rpb259O1xuICBfY2FsbElEOiBudW1iZXI7XG4gIF9sYXN0Rmx1c2g6IG51bWJlcjtcbiAgX2V2ZW50TG9vcFN0YXJ0VGltZTogbnVtYmVyO1xuICBfaW1tZWRpYXRlc0NhbGxiYWNrOiA/KCkgPT4gdm9pZDtcblxuICBfZGVidWdJbmZvOiB7W251bWJlcl06IFtudW1iZXIsIG51bWJlcl19O1xuICBfcmVtb3RlTW9kdWxlVGFibGU6IHtbbnVtYmVyXTogc3RyaW5nfTtcbiAgX3JlbW90ZU1ldGhvZFRhYmxlOiB7W251bWJlcl06IHN0cmluZ1tdfTtcblxuICBfX3NweTogPyhkYXRhOiBTcHlEYXRhKSA9PiB2b2lkO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuX2xhenlDYWxsYWJsZU1vZHVsZXMgPSB7fTtcbiAgICB0aGlzLl9xdWV1ZSA9IFtbXSwgW10sIFtdLCAwXTtcbiAgICB0aGlzLl9zdWNjZXNzQ2FsbGJhY2tzID0ge307XG4gICAgdGhpcy5fZmFpbHVyZUNhbGxiYWNrcyA9IHt9O1xuICAgIHRoaXMuX2NhbGxJRCA9IDA7XG4gICAgdGhpcy5fbGFzdEZsdXNoID0gMDtcbiAgICB0aGlzLl9ldmVudExvb3BTdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIHRoaXMuX2ltbWVkaWF0ZXNDYWxsYmFjayA9IG51bGw7XG5cbiAgICBpZiAoX19ERVZfXykge1xuICAgICAgdGhpcy5fZGVidWdJbmZvID0ge307XG4gICAgICB0aGlzLl9yZW1vdGVNb2R1bGVUYWJsZSA9IHt9O1xuICAgICAgdGhpcy5fcmVtb3RlTWV0aG9kVGFibGUgPSB7fTtcbiAgICB9XG5cbiAgICAodGhpczogYW55KS5jYWxsRnVuY3Rpb25SZXR1cm5GbHVzaGVkUXVldWUgPSB0aGlzLmNhbGxGdW5jdGlvblJldHVybkZsdXNoZWRRdWV1ZS5iaW5kKFxuICAgICAgdGhpcyxcbiAgICApO1xuICAgICh0aGlzOiBhbnkpLmNhbGxGdW5jdGlvblJldHVyblJlc3VsdEFuZEZsdXNoZWRRdWV1ZSA9IHRoaXMuY2FsbEZ1bmN0aW9uUmV0dXJuUmVzdWx0QW5kRmx1c2hlZFF1ZXVlLmJpbmQoXG4gICAgICB0aGlzLFxuICAgICk7XG4gICAgKHRoaXM6IGFueSkuZmx1c2hlZFF1ZXVlID0gdGhpcy5mbHVzaGVkUXVldWUuYmluZCh0aGlzKTtcbiAgICAodGhpczogYW55KS5pbnZva2VDYWxsYmFja0FuZFJldHVybkZsdXNoZWRRdWV1ZSA9IHRoaXMuaW52b2tlQ2FsbGJhY2tBbmRSZXR1cm5GbHVzaGVkUXVldWUuYmluZChcbiAgICAgIHRoaXMsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQdWJsaWMgQVBJc1xuICAgKi9cblxuICBzdGF0aWMgc3B5KHNweU9yVG9nZ2xlOiBib29sZWFuIHwgKChkYXRhOiBTcHlEYXRhKSA9PiB2b2lkKSkge1xuICAgIGlmIChzcHlPclRvZ2dsZSA9PT0gdHJ1ZSkge1xuICAgICAgTWVzc2FnZVF1ZXVlLnByb3RvdHlwZS5fX3NweSA9IGluZm8gPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBgJHtpbmZvLnR5cGUgPT09IFRPX0pTID8gJ04tPkpTJyA6ICdKUy0+Tid9IDogYCArXG4gICAgICAgICAgICBgJHtpbmZvLm1vZHVsZSA/IGluZm8ubW9kdWxlICsgJy4nIDogJyd9JHtpbmZvLm1ldGhvZH1gICtcbiAgICAgICAgICAgIGAoJHtKU09OLnN0cmluZ2lmeShpbmZvLmFyZ3MpfSlgLFxuICAgICAgICApO1xuICAgICAgfTtcbiAgICB9IGVsc2UgaWYgKHNweU9yVG9nZ2xlID09PSBmYWxzZSkge1xuICAgICAgTWVzc2FnZVF1ZXVlLnByb3RvdHlwZS5fX3NweSA9IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIE1lc3NhZ2VRdWV1ZS5wcm90b3R5cGUuX19zcHkgPSBzcHlPclRvZ2dsZTtcbiAgICB9XG4gIH1cblxuICBjYWxsRnVuY3Rpb25SZXR1cm5GbHVzaGVkUXVldWUobW9kdWxlOiBzdHJpbmcsIG1ldGhvZDogc3RyaW5nLCBhcmdzOiBhbnlbXSkge1xuICAgIHRoaXMuX19ndWFyZCgoKSA9PiB7XG4gICAgICB0aGlzLl9fY2FsbEZ1bmN0aW9uKG1vZHVsZSwgbWV0aG9kLCBhcmdzKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLmZsdXNoZWRRdWV1ZSgpO1xuICB9XG5cbiAgY2FsbEZ1bmN0aW9uUmV0dXJuUmVzdWx0QW5kRmx1c2hlZFF1ZXVlKFxuICAgIG1vZHVsZTogc3RyaW5nLFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIGFyZ3M6IGFueVtdLFxuICApIHtcbiAgICBsZXQgcmVzdWx0O1xuICAgIHRoaXMuX19ndWFyZCgoKSA9PiB7XG4gICAgICByZXN1bHQgPSB0aGlzLl9fY2FsbEZ1bmN0aW9uKG1vZHVsZSwgbWV0aG9kLCBhcmdzKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBbcmVzdWx0LCB0aGlzLmZsdXNoZWRRdWV1ZSgpXTtcbiAgfVxuXG4gIGludm9rZUNhbGxiYWNrQW5kUmV0dXJuRmx1c2hlZFF1ZXVlKGNiSUQ6IG51bWJlciwgYXJnczogYW55W10pIHtcbiAgICB0aGlzLl9fZ3VhcmQoKCkgPT4ge1xuICAgICAgdGhpcy5fX2ludm9rZUNhbGxiYWNrKGNiSUQsIGFyZ3MpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuZmx1c2hlZFF1ZXVlKCk7XG4gIH1cblxuICBmbHVzaGVkUXVldWUoKSB7XG4gICAgdGhpcy5fX2d1YXJkKCgpID0+IHtcbiAgICAgIHRoaXMuX19jYWxsSW1tZWRpYXRlcygpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcXVldWUgPSB0aGlzLl9xdWV1ZTtcbiAgICB0aGlzLl9xdWV1ZSA9IFtbXSwgW10sIFtdLCB0aGlzLl9jYWxsSURdO1xuICAgIHJldHVybiBxdWV1ZVswXS5sZW5ndGggPyBxdWV1ZSA6IG51bGw7XG4gIH1cblxuICBnZXRFdmVudExvb3BSdW5uaW5nVGltZSgpIHtcbiAgICByZXR1cm4gRGF0ZS5ub3coKSAtIHRoaXMuX2V2ZW50TG9vcFN0YXJ0VGltZTtcbiAgfVxuXG4gIHJlZ2lzdGVyQ2FsbGFibGVNb2R1bGUobmFtZTogc3RyaW5nLCBtb2R1bGU6IE9iamVjdCkge1xuICAgIHRoaXMuX2xhenlDYWxsYWJsZU1vZHVsZXNbbmFtZV0gPSAoKSA9PiBtb2R1bGU7XG4gIH1cblxuICByZWdpc3RlckxhenlDYWxsYWJsZU1vZHVsZShuYW1lOiBzdHJpbmcsIGZhY3Rvcnk6IHZvaWQgPT4gT2JqZWN0KSB7XG4gICAgbGV0IG1vZHVsZTogT2JqZWN0O1xuICAgIGxldCBnZXRWYWx1ZTogPyh2b2lkKSA9PiBPYmplY3QgPSBmYWN0b3J5O1xuICAgIHRoaXMuX2xhenlDYWxsYWJsZU1vZHVsZXNbbmFtZV0gPSAoKSA9PiB7XG4gICAgICBpZiAoZ2V0VmFsdWUpIHtcbiAgICAgICAgbW9kdWxlID0gZ2V0VmFsdWUoKTtcbiAgICAgICAgZ2V0VmFsdWUgPSBudWxsO1xuICAgICAgfVxuICAgICAgcmV0dXJuIG1vZHVsZTtcbiAgICB9O1xuICB9XG5cbiAgZ2V0Q2FsbGFibGVNb2R1bGUobmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgZ2V0VmFsdWUgPSB0aGlzLl9sYXp5Q2FsbGFibGVNb2R1bGVzW25hbWVdO1xuICAgIHJldHVybiBnZXRWYWx1ZSA/IGdldFZhbHVlKCkgOiBudWxsO1xuICB9XG5cbiAgZW5xdWV1ZU5hdGl2ZUNhbGwoXG4gICAgbW9kdWxlSUQ6IG51bWJlcixcbiAgICBtZXRob2RJRDogbnVtYmVyLFxuICAgIHBhcmFtczogYW55W10sXG4gICAgb25GYWlsOiA/RnVuY3Rpb24sXG4gICAgb25TdWNjOiA/RnVuY3Rpb24sXG4gICkge1xuICAgIGlmIChvbkZhaWwgfHwgb25TdWNjKSB7XG4gICAgICBpZiAoX19ERVZfXykge1xuICAgICAgICB0aGlzLl9kZWJ1Z0luZm9bdGhpcy5fY2FsbElEXSA9IFttb2R1bGVJRCwgbWV0aG9kSURdO1xuICAgICAgICBpZiAodGhpcy5fY2FsbElEID4gREVCVUdfSU5GT19MSU1JVCkge1xuICAgICAgICAgIGRlbGV0ZSB0aGlzLl9kZWJ1Z0luZm9bdGhpcy5fY2FsbElEIC0gREVCVUdfSU5GT19MSU1JVF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIEVuY29kZSBjYWxsSURzIGludG8gcGFpcnMgb2YgY2FsbGJhY2sgaWRlbnRpZmllcnMgYnkgc2hpZnRpbmcgbGVmdCBhbmQgdXNpbmcgdGhlIHJpZ2h0bW9zdCBiaXRcbiAgICAgIC8vIHRvIGluZGljYXRlIGZhaWwgKDApIG9yIHN1Y2Nlc3MgKDEpXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYml0d2lzZVxuICAgICAgb25GYWlsICYmIHBhcmFtcy5wdXNoKHRoaXMuX2NhbGxJRCA8PCAxKTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1iaXR3aXNlXG4gICAgICBvblN1Y2MgJiYgcGFyYW1zLnB1c2goKHRoaXMuX2NhbGxJRCA8PCAxKSB8IDEpO1xuICAgICAgdGhpcy5fc3VjY2Vzc0NhbGxiYWNrc1t0aGlzLl9jYWxsSURdID0gb25TdWNjO1xuICAgICAgdGhpcy5fZmFpbHVyZUNhbGxiYWNrc1t0aGlzLl9jYWxsSURdID0gb25GYWlsO1xuICAgIH1cblxuICAgIGlmIChfX0RFVl9fKSB7XG4gICAgICBnbG9iYWwubmF0aXZlVHJhY2VCZWdpbkFzeW5jRmxvdyAmJlxuICAgICAgICBnbG9iYWwubmF0aXZlVHJhY2VCZWdpbkFzeW5jRmxvdyhcbiAgICAgICAgICBUUkFDRV9UQUdfUkVBQ1RfQVBQUyxcbiAgICAgICAgICAnbmF0aXZlJyxcbiAgICAgICAgICB0aGlzLl9jYWxsSUQsXG4gICAgICAgICk7XG4gICAgfVxuICAgIHRoaXMuX2NhbGxJRCsrO1xuXG4gICAgdGhpcy5fcXVldWVbTU9EVUxFX0lEU10ucHVzaChtb2R1bGVJRCk7XG4gICAgdGhpcy5fcXVldWVbTUVUSE9EX0lEU10ucHVzaChtZXRob2RJRCk7XG5cbiAgICBpZiAoX19ERVZfXykge1xuICAgICAgLy8gVmFsaWRhdGUgdGhhdCBwYXJhbWV0ZXJzIHBhc3NlZCBvdmVyIHRoZSBicmlkZ2UgYXJlXG4gICAgICAvLyBmb2xseS1jb252ZXJ0aWJsZS4gIEFzIGEgc3BlY2lhbCBjYXNlLCBpZiBhIHByb3AgdmFsdWUgaXMgYVxuICAgICAgLy8gZnVuY3Rpb24gaXQgaXMgcGVybWl0dGVkIGhlcmUsIGFuZCBzcGVjaWFsLWNhc2VkIGluIHRoZVxuICAgICAgLy8gY29udmVyc2lvbi5cbiAgICAgIGNvbnN0IGlzVmFsaWRBcmd1bWVudCA9IHZhbCA9PiB7XG4gICAgICAgIGNvbnN0IHQgPSB0eXBlb2YgdmFsO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgdCA9PT0gJ3VuZGVmaW5lZCcgfHxcbiAgICAgICAgICB0ID09PSAnbnVsbCcgfHxcbiAgICAgICAgICB0ID09PSAnYm9vbGVhbicgfHxcbiAgICAgICAgICB0ID09PSAnc3RyaW5nJ1xuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICByZXR1cm4gaXNGaW5pdGUodmFsKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodCA9PT0gJ2Z1bmN0aW9uJyB8fCB0ICE9PSAnb2JqZWN0Jykge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7XG4gICAgICAgICAgcmV0dXJuIHZhbC5ldmVyeShpc1ZhbGlkQXJndW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgayBpbiB2YWwpIHtcbiAgICAgICAgICBpZiAodHlwZW9mIHZhbFtrXSAhPT0gJ2Z1bmN0aW9uJyAmJiAhaXNWYWxpZEFyZ3VtZW50KHZhbFtrXSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9O1xuXG4gICAgICAvLyBSZXBsYWNlbWVudCBhbGxvd3Mgbm9ybWFsbHkgbm9uLUpTT04tY29udmVydGlibGUgdmFsdWVzIHRvIGJlXG4gICAgICAvLyBzZWVuLiAgVGhlcmUgaXMgYW1iaWd1aXR5IHdpdGggc3RyaW5nIHZhbHVlcywgYnV0IGluIGNvbnRleHQsXG4gICAgICAvLyBpdCBzaG91bGQgYXQgbGVhc3QgYmUgYSBzdHJvbmcgaGludC5cbiAgICAgIGNvbnN0IHJlcGxhY2VyID0gKGtleSwgdmFsKSA9PiB7XG4gICAgICAgIGNvbnN0IHQgPSB0eXBlb2YgdmFsO1xuICAgICAgICBpZiAodCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIHJldHVybiAnPDxGdW5jdGlvbiAnICsgdmFsLm5hbWUgKyAnPj4nO1xuICAgICAgICB9IGVsc2UgaWYgKHQgPT09ICdudW1iZXInICYmICFpc0Zpbml0ZSh2YWwpKSB7XG4gICAgICAgICAgcmV0dXJuICc8PCcgKyB2YWwudG9TdHJpbmcoKSArICc+Pic7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHZhbDtcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgLy8gTm90ZSB0aGF0IEpTT04uc3RyaW5naWZ5XG4gICAgICBpbnZhcmlhbnQoXG4gICAgICAgIGlzVmFsaWRBcmd1bWVudChwYXJhbXMpLFxuICAgICAgICAnJXMgaXMgbm90IHVzYWJsZSBhcyBhIG5hdGl2ZSBtZXRob2QgYXJndW1lbnQnLFxuICAgICAgICBKU09OLnN0cmluZ2lmeShwYXJhbXMsIHJlcGxhY2VyKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIFRoZSBwYXJhbXMgb2JqZWN0IHNob3VsZCBub3QgYmUgbXV0YXRlZCBhZnRlciBiZWluZyBxdWV1ZWRcbiAgICAgIGRlZXBGcmVlemVBbmRUaHJvd09uTXV0YXRpb25JbkRldigocGFyYW1zOiBhbnkpKTtcbiAgICB9XG4gICAgdGhpcy5fcXVldWVbUEFSQU1TXS5wdXNoKHBhcmFtcyk7XG5cbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGlmIChcbiAgICAgIGdsb2JhbC5uYXRpdmVGbHVzaFF1ZXVlSW1tZWRpYXRlICYmXG4gICAgICBub3cgLSB0aGlzLl9sYXN0Rmx1c2ggPj0gTUlOX1RJTUVfQkVUV0VFTl9GTFVTSEVTX01TXG4gICAgKSB7XG4gICAgICBjb25zdCBxdWV1ZSA9IHRoaXMuX3F1ZXVlO1xuICAgICAgdGhpcy5fcXVldWUgPSBbW10sIFtdLCBbXSwgdGhpcy5fY2FsbElEXTtcbiAgICAgIHRoaXMuX2xhc3RGbHVzaCA9IG5vdztcbiAgICAgIGdsb2JhbC5uYXRpdmVGbHVzaFF1ZXVlSW1tZWRpYXRlKHF1ZXVlKTtcbiAgICB9XG4gICAgU3lzdHJhY2UuY291bnRlckV2ZW50KCdwZW5kaW5nX2pzX3RvX25hdGl2ZV9xdWV1ZScsIHRoaXMuX3F1ZXVlWzBdLmxlbmd0aCk7XG4gICAgaWYgKF9fREVWX18gJiYgdGhpcy5fX3NweSAmJiBpc0Zpbml0ZShtb2R1bGVJRCkpIHtcbiAgICAgIHRoaXMuX19zcHkoe1xuICAgICAgICB0eXBlOiBUT19OQVRJVkUsXG4gICAgICAgIG1vZHVsZTogdGhpcy5fcmVtb3RlTW9kdWxlVGFibGVbbW9kdWxlSURdLFxuICAgICAgICBtZXRob2Q6IHRoaXMuX3JlbW90ZU1ldGhvZFRhYmxlW21vZHVsZUlEXVttZXRob2RJRF0sXG4gICAgICAgIGFyZ3M6IHBhcmFtcyxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAodGhpcy5fX3NweSkge1xuICAgICAgdGhpcy5fX3NweSh7XG4gICAgICAgIHR5cGU6IFRPX05BVElWRSxcbiAgICAgICAgbW9kdWxlOiBtb2R1bGVJRCArICcnLFxuICAgICAgICBtZXRob2Q6IG1ldGhvZElELFxuICAgICAgICBhcmdzOiBwYXJhbXMsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBjcmVhdGVEZWJ1Z0xvb2t1cChtb2R1bGVJRDogbnVtYmVyLCBuYW1lOiBzdHJpbmcsIG1ldGhvZHM6IHN0cmluZ1tdKSB7XG4gICAgaWYgKF9fREVWX18pIHtcbiAgICAgIHRoaXMuX3JlbW90ZU1vZHVsZVRhYmxlW21vZHVsZUlEXSA9IG5hbWU7XG4gICAgICB0aGlzLl9yZW1vdGVNZXRob2RUYWJsZVttb2R1bGVJRF0gPSBtZXRob2RzO1xuICAgIH1cbiAgfVxuXG4gIC8vIEZvciBKU1RpbWVycyB0byByZWdpc3RlciBpdHMgY2FsbGJhY2suIE90aGVyd2lzZSBhIGNpcmN1bGFyIGRlcGVuZGVuY3lcbiAgLy8gYmV0d2VlbiBtb2R1bGVzIGlzIGludHJvZHVjZWQuIE5vdGUgdGhhdCBvbmx5IG9uZSBjYWxsYmFjayBtYXkgYmVcbiAgLy8gcmVnaXN0ZXJlZCBhdCBhIHRpbWUuXG4gIHNldEltbWVkaWF0ZXNDYWxsYmFjayhmbjogKCkgPT4gdm9pZCkge1xuICAgIHRoaXMuX2ltbWVkaWF0ZXNDYWxsYmFjayA9IGZuO1xuICB9XG5cbiAgLyoqXG4gICAqIFByaXZhdGUgbWV0aG9kc1xuICAgKi9cblxuICBfX2d1YXJkKGZuOiAoKSA9PiB2b2lkKSB7XG4gICAgaWYgKHRoaXMuX19zaG91bGRQYXVzZU9uVGhyb3coKSkge1xuICAgICAgZm4oKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdHJ5IHtcbiAgICAgICAgZm4oKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIEVycm9yVXRpbHMucmVwb3J0RmF0YWxFcnJvcihlcnJvcik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gTWVzc2FnZVF1ZXVlIGluc3RhbGxzIGEgZ2xvYmFsIGhhbmRsZXIgdG8gY2F0Y2ggYWxsIGV4Y2VwdGlvbnMgd2hlcmUgSlMgdXNlcnMgY2FuIHJlZ2lzdGVyIHRoZWlyIG93biBiZWhhdmlvclxuICAvLyBUaGlzIGhhbmRsZXIgbWFrZXMgYWxsIGV4Y2VwdGlvbnMgdG8gYmUgcHJvcGFnYXRlZCBmcm9tIGluc2lkZSBNZXNzYWdlUXVldWUgcmF0aGVyIHRoYW4gYnkgdGhlIFZNIGF0IHRoZWlyIG9yaWdpblxuICAvLyBUaGlzIG1ha2VzIHN0YWNrdHJhY2VzIHRvIGJlIHBsYWNlZCBhdCBNZXNzYWdlUXVldWUgcmF0aGVyIHRoYW4gYXQgd2hlcmUgdGhleSB3ZXJlIGxhdW5jaGVkXG4gIC8vIFRoZSBwYXJhbWV0ZXIgRGVidWdnZXJJbnRlcm5hbC5zaG91bGRQYXVzZU9uVGhyb3cgaXMgdXNlZCB0byBjaGVjayBiZWZvcmUgY2F0Y2hpbmcgYWxsIGV4Y2VwdGlvbnMgYW5kXG4gIC8vIGNhbiBiZSBjb25maWd1cmVkIGJ5IHRoZSBWTSBvciBhbnkgSW5zcGVjdG9yXG4gIF9fc2hvdWxkUGF1c2VPblRocm93KCkge1xuICAgIHJldHVybiAoXG4gICAgICAvLyAkRmxvd0ZpeE1lXG4gICAgICB0eXBlb2YgRGVidWdnZXJJbnRlcm5hbCAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICAgIERlYnVnZ2VySW50ZXJuYWwuc2hvdWxkUGF1c2VPblRocm93ID09PSB0cnVlIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW5kZWZcbiAgICApO1xuICB9XG5cbiAgX19jYWxsSW1tZWRpYXRlcygpIHtcbiAgICBTeXN0cmFjZS5iZWdpbkV2ZW50KCdKU1RpbWVycy5jYWxsSW1tZWRpYXRlcygpJyk7XG4gICAgaWYgKHRoaXMuX2ltbWVkaWF0ZXNDYWxsYmFjayAhPSBudWxsKSB7XG4gICAgICB0aGlzLl9pbW1lZGlhdGVzQ2FsbGJhY2soKTtcbiAgICB9XG4gICAgU3lzdHJhY2UuZW5kRXZlbnQoKTtcbiAgfVxuXG4gIF9fY2FsbEZ1bmN0aW9uKG1vZHVsZTogc3RyaW5nLCBtZXRob2Q6IHN0cmluZywgYXJnczogYW55W10pOiBhbnkge1xuICAgIHRoaXMuX2xhc3RGbHVzaCA9IERhdGUubm93KCk7XG4gICAgdGhpcy5fZXZlbnRMb29wU3RhcnRUaW1lID0gdGhpcy5fbGFzdEZsdXNoO1xuICAgIGlmIChfX0RFVl9fIHx8IHRoaXMuX19zcHkpIHtcbiAgICAgIFN5c3RyYWNlLmJlZ2luRXZlbnQoYCR7bW9kdWxlfS4ke21ldGhvZH0oJHtzdHJpbmdpZnlTYWZlKGFyZ3MpfSlgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgU3lzdHJhY2UuYmVnaW5FdmVudChgJHttb2R1bGV9LiR7bWV0aG9kfSguLi4pYCk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9fc3B5KSB7XG4gICAgICB0aGlzLl9fc3B5KHt0eXBlOiBUT19KUywgbW9kdWxlLCBtZXRob2QsIGFyZ3N9KTtcbiAgICB9XG4gICAgY29uc3QgbW9kdWxlTWV0aG9kcyA9IHRoaXMuZ2V0Q2FsbGFibGVNb2R1bGUobW9kdWxlKTtcbiAgICBpbnZhcmlhbnQoXG4gICAgICAhIW1vZHVsZU1ldGhvZHMsXG4gICAgICAnTW9kdWxlICVzIGlzIG5vdCBhIHJlZ2lzdGVyZWQgY2FsbGFibGUgbW9kdWxlIChjYWxsaW5nICVzKScsXG4gICAgICBtb2R1bGUsXG4gICAgICBtZXRob2QsXG4gICAgKTtcbiAgICBpbnZhcmlhbnQoXG4gICAgICAhIW1vZHVsZU1ldGhvZHNbbWV0aG9kXSxcbiAgICAgICdNZXRob2QgJXMgZG9lcyBub3QgZXhpc3Qgb24gbW9kdWxlICVzJyxcbiAgICAgIG1ldGhvZCxcbiAgICAgIG1vZHVsZSxcbiAgICApO1xuICAgIGNvbnN0IHJlc3VsdCA9IG1vZHVsZU1ldGhvZHNbbWV0aG9kXS5hcHBseShtb2R1bGVNZXRob2RzLCBhcmdzKTtcbiAgICBTeXN0cmFjZS5lbmRFdmVudCgpO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBfX2ludm9rZUNhbGxiYWNrKGNiSUQ6IG51bWJlciwgYXJnczogYW55W10pIHtcbiAgICB0aGlzLl9sYXN0Rmx1c2ggPSBEYXRlLm5vdygpO1xuICAgIHRoaXMuX2V2ZW50TG9vcFN0YXJ0VGltZSA9IHRoaXMuX2xhc3RGbHVzaDtcblxuICAgIC8vIFRoZSByaWdodG1vc3QgYml0IG9mIGNiSUQgaW5kaWNhdGVzIGZhaWwgKDApIG9yIHN1Y2Nlc3MgKDEpLCB0aGUgb3RoZXIgYml0cyBhcmUgdGhlIGNhbGxJRCBzaGlmdGVkIGxlZnQuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWJpdHdpc2VcbiAgICBjb25zdCBjYWxsSUQgPSBjYklEID4+PiAxO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1iaXR3aXNlXG4gICAgY29uc3QgaXNTdWNjZXNzID0gY2JJRCAmIDE7XG4gICAgY29uc3QgY2FsbGJhY2sgPSBpc1N1Y2Nlc3NcbiAgICAgID8gdGhpcy5fc3VjY2Vzc0NhbGxiYWNrc1tjYWxsSURdXG4gICAgICA6IHRoaXMuX2ZhaWx1cmVDYWxsYmFja3NbY2FsbElEXTtcblxuICAgIGlmIChfX0RFVl9fKSB7XG4gICAgICBjb25zdCBkZWJ1ZyA9IHRoaXMuX2RlYnVnSW5mb1tjYWxsSURdO1xuICAgICAgY29uc3QgbW9kdWxlID0gZGVidWcgJiYgdGhpcy5fcmVtb3RlTW9kdWxlVGFibGVbZGVidWdbMF1dO1xuICAgICAgY29uc3QgbWV0aG9kID0gZGVidWcgJiYgdGhpcy5fcmVtb3RlTWV0aG9kVGFibGVbZGVidWdbMF1dW2RlYnVnWzFdXTtcbiAgICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgICAgbGV0IGVycm9yTWVzc2FnZSA9IGBDYWxsYmFjayB3aXRoIGlkICR7Y2JJRH06ICR7bW9kdWxlfS4ke21ldGhvZH0oKSBub3QgZm91bmRgO1xuICAgICAgICBpZiAobWV0aG9kKSB7XG4gICAgICAgICAgZXJyb3JNZXNzYWdlID1cbiAgICAgICAgICAgIGBUaGUgY2FsbGJhY2sgJHttZXRob2R9KCkgZXhpc3RzIGluIG1vZHVsZSAke21vZHVsZX0sIGAgK1xuICAgICAgICAgICAgJ2J1dCBvbmx5IG9uZSBjYWxsYmFjayBtYXkgYmUgcmVnaXN0ZXJlZCB0byBhIGZ1bmN0aW9uIGluIGEgbmF0aXZlIG1vZHVsZS4nO1xuICAgICAgICB9XG4gICAgICAgIGludmFyaWFudChjYWxsYmFjaywgZXJyb3JNZXNzYWdlKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHByb2ZpbGVOYW1lID0gZGVidWdcbiAgICAgICAgPyAnPGNhbGxiYWNrIGZvciAnICsgbW9kdWxlICsgJy4nICsgbWV0aG9kICsgJz4nXG4gICAgICAgIDogY2JJRDtcbiAgICAgIGlmIChjYWxsYmFjayAmJiB0aGlzLl9fc3B5KSB7XG4gICAgICAgIHRoaXMuX19zcHkoe3R5cGU6IFRPX0pTLCBtb2R1bGU6IG51bGwsIG1ldGhvZDogcHJvZmlsZU5hbWUsIGFyZ3N9KTtcbiAgICAgIH1cbiAgICAgIFN5c3RyYWNlLmJlZ2luRXZlbnQoXG4gICAgICAgIGBNZXNzYWdlUXVldWUuaW52b2tlQ2FsbGJhY2soJHtwcm9maWxlTmFtZX0sICR7c3RyaW5naWZ5U2FmZShhcmdzKX0pYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGRlbGV0ZSB0aGlzLl9zdWNjZXNzQ2FsbGJhY2tzW2NhbGxJRF07XG4gICAgZGVsZXRlIHRoaXMuX2ZhaWx1cmVDYWxsYmFja3NbY2FsbElEXTtcbiAgICBjYWxsYmFjayguLi5hcmdzKTtcblxuICAgIGlmIChfX0RFVl9fKSB7XG4gICAgICBTeXN0cmFjZS5lbmRFdmVudCgpO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE1lc3NhZ2VRdWV1ZTtcbiJdfQ==